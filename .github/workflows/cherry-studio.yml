name: cherry-studio

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # 每天的00:00触发
  push:
    branches:
      - run

jobs:
  get-latest-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      amd64_url: ${{ steps.get_download_urls.outputs.amd64_url }}
      arm64_url: ${{ steps.get_download_urls.outputs.arm64_url }}
    steps:
      - name: Get latest release info
        id: get_version
        run: |
          RELEASE_INFO=$(curl -s https://api.github.com/repos/CherryHQ/cherry-studio/releases/latest)
          LATEST_TAG=$(echo "$RELEASE_INFO" | sed -n 's/.*"tag_name": "\([^"]*\)".*/\1/p')
          echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest version: $LATEST_TAG"

      - name: Get download URLs
        id: get_download_urls
        run: |
          RELEASE_INFO=$(curl -s https://api.github.com/repos/CherryHQ/cherry-studio/releases/latest)
          
          AMD64_URL=$(echo "$RELEASE_INFO" | sed -n 's/.*"browser_download_url": "\([^"]*amd64\.deb\)".*/\1/p' | head -1)
          if [ -z "$AMD64_URL" ]; then
            AMD64_URL=$(echo "$RELEASE_INFO" | sed -n 's/.*"browser_download_url": "\([^"]*\.deb\)".*/\1/p' | grep -i amd64 | head -1)
          fi
          
          ARM64_URL=$(echo "$RELEASE_INFO" | sed -n 's/.*"browser_download_url": "\([^"]*arm64\.deb\)".*/\1/p' | head -1)
          if [ -z "$ARM64_URL" ]; then
            ARM64_URL=$(echo "$RELEASE_INFO" | sed -n 's/.*"browser_download_url": "\([^"]*\.deb\)".*/\1/p' | grep -i arm64 | head -1)
          fi
          
          echo "amd64_url=$AMD64_URL" >> $GITHUB_OUTPUT
          echo "arm64_url=$ARM64_URL" >> $GITHUB_OUTPUT

  build-and-push:
    needs: get-latest-version
    runs-on: ubuntu-latest
    env:
      PROJECT_NAME: cherry-studio
      IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/cherry-studio
      REPO_URL: ${{ vars.REPO_URL }}        # 新增：仓库URL变量
      REPO_PATH: ${{ vars.REPO_PATH }}      # 新增：仓库本地路径变量
    steps:
      # 拉取私有仓库代码（使用 GitHub PAT）
      - name: Pull project code
        env:
          REPO_ACCESS_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          git clone https://$REPO_ACCESS_TOKEN@$REPO_URL $REPO_PATH

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 下载两种架构的 deb 包到构建上下文
      - name: Download Cherry Studio deb packages
        run: |
          echo "Current directory contents:"
          ls -la
          echo "REPO_PATH directory contents:"
          ls -la $REPO_PATH
          mkdir -p $REPO_PATH/$PROJECT_NAME
          echo "REPO_PATH/PROJECT_NAME directory contents:"
          ls -la $REPO_PATH/$PROJECT_NAME
          if [ -n "${{ needs.get-latest-version.outputs.amd64_url }}" ]; then
            curl -L -o "$REPO_PATH/$PROJECT_NAME/cherry-studio-amd64.deb" "${{ needs.get-latest-version.outputs.amd64_url }}"
          fi
          
          if [ -n "${{ needs.get-latest-version.outputs.arm64_url }}" ]; then
            curl -L -o "$REPO_PATH/$PROJECT_NAME/cherry-studio-arm64.deb" "${{ needs.get-latest-version.outputs.arm64_url }}"
          fi

      - name: Build and push multi-arch image
        uses: docker/build-push-action@v5
        with:
          context: $REPO_PATH/$PROJECT_NAME
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/cherry-studio:${{ needs.get-latest-version.outputs.version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/cherry-studio:latest
