name: linux app build (Multi-App)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
  push:
    branches:
      - run

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      # 设置为 false，即使其中一个应用构建失败，其他应用也会继续构建
      fail-fast: false 
      matrix:
        # 在这里定义你的应用数组
        app_name: [clash-verge] 

    env:
      # 使用 matrix.app_name 动态生成镜像名
      IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.app_name }}
      REPO_URL: ${{ vars.REPO_URL }}
      REPO_PATH: ${{ vars.REPO_PATH }}

    steps:
      - name: Pull project code
        env:
          REPO_ACCESS_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          git clone https://$REPO_ACCESS_TOKEN@$REPO_URL $REPO_PATH

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2 # 建议更新到 v2

      - name: Login to DockerHub
        uses: docker/login-action@v2 # 建议使用官方 Action，更安全简洁
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 构建临时 dev 镜像用于版本对比
      - name: Build temporary dev image
        run: |
          cd $REPO_PATH/${{ matrix.app_name }}
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t $IMAGE_NAME:dev \
            . --push

      - name: Extract version
        id: version
        run: |
          # 提取新版本
          NEW_VERSION=$(docker run --rm $IMAGE_NAME:dev cat /etc/cont-env.d/APP_VERSION)
          echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          
          # 提取旧版本
          if docker pull $IMAGE_NAME:latest 2>/dev/null; then
            OLD_VERSION=$(docker run --rm $IMAGE_NAME:latest cat /etc/cont-env.d/APP_VERSION)
          else
            OLD_VERSION="none"
          fi
          echo "old_version=${OLD_VERSION}" >> $GITHUB_OUTPUT

      - name: Push image if version changed
        if: steps.version.outputs.new_version != steps.version.outputs.old_version
        run: |
          VERSION="${{ steps.version.outputs.new_version }}"
          cd $REPO_PATH/${{ matrix.app_name }}
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t $IMAGE_NAME:$VERSION \
            -t $IMAGE_NAME:latest \
            . --push
          echo "Successfully pushed ${{ matrix.app_name }} version: $VERSION"