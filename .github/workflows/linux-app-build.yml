name: linux app build (Multi-App & Manual)

on:
  workflow_dispatch:
    inputs:
      apps:
        description: '输入要构建的应用名（多个用逗号分隔，留空则构建全部）'
        required: false
        default: ''
  schedule:
    - cron: '0 0 * * *'
  push:
    branches:
      - run

jobs:
  # 预处理任务：确定要构建的应用列表
  setup:
    runs-on: ubuntu-latest
    outputs:
      app_matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          # 1. 定义默认应用列表 (必须是标准 JSON 数组)
          DEFAULT_APPS='["clash-verge","clash-party","FlClash"]'
          
          INPUT_APPS="${{ github.event.inputs.apps }}"
          
          if [ -z "$INPUT_APPS" ]; then
            # 如果没输入，输出默认列表
            echo "matrix=$DEFAULT_APPS" >> $GITHUB_OUTPUT
          else
            # 2. 使用 jq 处理输入，确保格式完美无误
            # 逻辑：将输入按逗号切割 -> 去空格 -> 转换为 JSON 数组
            JSON_APPS=$(echo "$INPUT_APPS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R . | jq -s -c .)
            echo "matrix=$JSON_APPS" >> $GITHUB_OUTPUT
          fi

  build:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app_name: ${{ fromJson(needs.setup.outputs.app_matrix) }}

    env:
      REPO_URL: ${{ vars.REPO_URL }}
      REPO_PATH: ${{ vars.REPO_PATH }}

    steps:
      - name: Set lower case image name
        run: |
          APP_LOWER=$(echo "${{ matrix.app_name }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/$APP_LOWER" >> $GITHUB_ENV

      - name: Pull project code
        env:
          REPO_ACCESS_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          git clone https://$REPO_ACCESS_TOKEN@$REPO_URL $REPO_PATH

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # --- 步骤：构建并检查版本（同上个版本） ---
      - name: Build temporary dev image
        run: |
          cd $REPO_PATH/${{ matrix.app_name }}
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t $IMAGE_NAME:dev \
            . --push

      - name: Extract version
        id: version
        run: |
          # 1. 提取原始版本号 (增加 60s 超时处理)
          echo "Fetching version from dev image..."
          RAW_VERSION=$(timeout 60s docker run --rm $IMAGE_NAME:dev cat /etc/cont-env.d/APP_VERSION | xargs)
          
          # 检查 timeout 是否触发（退出码 124 表示超时）
          if [ $? -eq 124 ]; then
            echo "Error: Getting version timed out after 60 seconds"
            exit 1
          fi

          echo "Raw version: $RAW_VERSION"

          # 2. 将非法字符（如 +）替换为下划线 _
          # 这样 0.8.91+2025122201 会变成 0.8.91_2025122201
          SAFE_VERSION=$(echo "$RAW_VERSION" | sed 's/[^a-zA-Z0-9._-]/_/g')
          echo "Safe version: $SAFE_VERSION"

          # 3. 输出处理后的安全版本号
          echo "new_version=${SAFE_VERSION}" >> $GITHUB_OUTPUT
          
          # 提取旧版本对比逻辑保持不变
          if docker pull $IMAGE_NAME:latest 2>/dev/null; then
            OLD_RAW=$(docker run --rm $IMAGE_NAME:latest cat /etc/cont-env.d/APP_VERSION | xargs)
            OLD_SAFE=$(echo "$OLD_RAW" | sed 's/[^a-zA-Z0-9._-]/_/g')
            echo "old_version=${OLD_SAFE}" >> $GITHUB_OUTPUT
          else
            echo "old_version=none" >> $GITHUB_OUTPUT
          fi

      - name: Push image if version changed
        if: steps.version.outputs.new_version != steps.version.outputs.old_version
        run: |
          VERSION="${{ steps.version.outputs.new_version }}"
          cd $REPO_PATH/${{ matrix.app_name }}
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t $IMAGE_NAME:$VERSION \
            -t $IMAGE_NAME:latest \
            . --push