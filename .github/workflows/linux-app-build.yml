name: linux app build (Multi-App & Manual)

on:
  workflow_dispatch:
    inputs:
      apps:
        description: '输入要构建的应用名（多个用逗号分隔，留空则构建全部）'
        required: false
        default: ''
  schedule:
    - cron: '0 0 * * *'
  push:
    branches:
      - run

jobs:
  # 预处理任务：确定要构建的应用列表
  setup:
    runs-on: ubuntu-latest
    outputs:
      app_matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          # 1. 定义默认应用列表 (必须是标准 JSON 数组)
          DEFAULT_APPS='["clash-verge"]'
          
          INPUT_APPS="${{ github.event.inputs.apps }}"
          
          if [ -z "$INPUT_APPS" ]; then
            # 如果没输入，输出默认列表
            echo "matrix=$DEFAULT_APPS" >> $GITHUB_OUTPUT
          else
            # 2. 使用 jq 处理输入，确保格式完美无误
            # 逻辑：将输入按逗号切割 -> 去空格 -> 转换为 JSON 数组
            JSON_APPS=$(echo "$INPUT_APPS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R . | jq -s -c .)
            echo "matrix=$JSON_APPS" >> $GITHUB_OUTPUT
          fi

  build:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app_name: ${{ fromJson(needs.setup.outputs.app_matrix) }}

    env:
      IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.app_name }}
      REPO_URL: ${{ vars.REPO_URL }}
      REPO_PATH: ${{ vars.REPO_PATH }}

    steps:
      - name: Pull project code
        env:
          REPO_ACCESS_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          git clone https://$REPO_ACCESS_TOKEN@$REPO_URL $REPO_PATH

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # --- 步骤：构建并检查版本（同上个版本） ---
      - name: Build temporary dev image
        run: |
          cd $REPO_PATH/${{ matrix.app_name }}
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t $IMAGE_NAME:dev \
            . --push

      - name: Extract version
        id: version
        run: |
          NEW_VERSION=$(docker run --rm $IMAGE_NAME:dev cat /etc/cont-env.d/APP_VERSION)
          echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          
          if docker pull $IMAGE_NAME:latest 2>/dev/null; then
            OLD_VERSION=$(docker run --rm $IMAGE_NAME:latest cat /etc/cont-env.d/APP_VERSION)
          else
            OLD_VERSION="none"
          fi
          echo "old_version=${OLD_VERSION}" >> $GITHUB_OUTPUT

      - name: Push image if version changed
        if: steps.version.outputs.new_version != steps.version.outputs.old_version
        run: |
          VERSION="${{ steps.version.outputs.new_version }}"
          cd $REPO_PATH/${{ matrix.app_name }}
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t $IMAGE_NAME:$VERSION \
            -t $IMAGE_NAME:latest \
            . --push