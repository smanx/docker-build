name: Build Docker from Repository
on:
  workflow_dispatch:
    inputs:
      repos:
        description: 'JSONæ•°ç»„æ ¼å¼çš„ä»“åº“ååˆ—è¡¨ï¼Œä¾‹å¦‚: ["owner/repo1", "owner/repo2"]'
        required: true
        default: '["owner/repo1"]'
      tags:
        description: 'é•œåƒæ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚: latest,1.0.0'
        required: false
        default: 'latest'

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ${{ fromJSON(github.event.inputs.repos) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Clone repository
        run: |
          REPO=${{ matrix.repo }}
          REPO_NAME=$(echo $REPO | cut -d'/' -f2)
          git clone https://github.com/$REPO.git $REPO_NAME
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
          echo "REPO_DIR=$REPO_NAME" >> $GITHUB_ENV

      - name: Build and push multi-arch Docker image
        run: |
          # ç¡®å®šé•œåƒåç§°
          IMAGE_NAME="${{ env.DOCKERHUB_USERNAME }}/${{ env.REPO_NAME }}"

          # å¤„ç†æ ‡ç­¾
          IFS=',' read -ra TAG_ARRAY <<< "${{ github.event.inputs.tags }}"
          BUILD_TAGS=""
          for tag in "${TAG_ARRAY[@]}"; do
            BUILD_TAGS="$BUILD_TAGS -t $IMAGE_NAME:$tag"
          done

          # æ„å»ºå¹¶æ¨é€å¤šæ¶æ„é•œåƒ
          cd ${{ env.REPO_DIR }}
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            $BUILD_TAGS \
            . --push

          echo "âœ… é•œåƒæ„å»ºå®Œæˆ: $IMAGE_NAME"
          echo "ğŸ“¦ æ”¯æŒæ¶æ„: linux/amd64, linux/arm64"